# DingHook + Mem0 é›†æˆ - å®Œæ•´å®ç°æ€»ç»“

## é¡¹ç›®å®ŒæˆçŠ¶æ€ âœ…

å·²æˆåŠŸå®Œæˆäº†åŸºäº Mem0 æ¡†æ¶çš„ DingHook ä¸ªæ€§åŒ–èŠå¤©ç³»ç»Ÿã€‚

## æ ¸å¿ƒå®ç°

### 1. å®Œæ•´æµç¨‹å®ç° âœ…

```
é’‰é’‰æ¶ˆæ¯ â†’ Mem0 add() â†’ Mem0 search() â†’ æ‹¼æ¥ Prompt â†’ LLM (Gemini) â†’ é’‰é’‰å›å¤
```

**æµç¨‹è¯¦ç»†è¯´æ˜ï¼š**

| æ­¥éª¤ | æ¨¡å— | åŠŸèƒ½ | ä»£ç ä½ç½® |
|------|------|------|---------|
| 1 | Flask Server | æ¥æ”¶é’‰é’‰ webhook æ¶ˆæ¯ | `server.py` |
| 2 | Mem0Manager | å°†å½“å‰æ¶ˆæ¯å­˜å…¥é•¿æœŸè®°å¿† | `mem0_manager.py:add_memory()` |
| 3 | Mem0Manager | æœç´¢ç›¸å…³çš„å†å²è®°å¿† | `mem0_manager.py:search_memories()` |
| 4 | Mem0Manager | æ ¼å¼åŒ–è®°å¿†ä¸ºä¸Šä¸‹æ–‡ | `mem0_manager.py:format_memories_as_context()` |
| 5 | Agent | æ‹¼æ¥å®Œæ•´çš„ç³»ç»Ÿæç¤ºè¯ | `agent.py:analyze_and_reply()` |
| 6 | Agent | è°ƒç”¨ Gemini LLM ç”Ÿæˆå›å¤ | `agent.py:_call_model()` |
| 7 | Sender | å°†å›å¤å‘é€å›é’‰é’‰ | `sender.py:send_text_from_env()` |

### 2. å…³é”®æ–‡ä»¶å®ç°

#### ğŸ“„ dingbot/mem0_manager.py (æ–°å»º)
- `Mem0Manager` ç±» - å°è£… Mem0 SDK æ“ä½œ
- æ ¸å¿ƒæ–¹æ³•ï¼š
  - `add_memory()` - å­˜å…¥å¯¹è¯
  - `search_memories()` - æœç´¢è®°å¿†
  - `format_memories_as_context()` - æ ¼å¼åŒ–ä¸Šä¸‹æ–‡
  - `get_user_profile()` - è·å–ç”¨æˆ·æ¦‚è§ˆ
  - `build_system_prompt()` - æ„å»ºå¢å¼ºæç¤ºè¯

#### ğŸ“„ dingbot/agent.py (æ”¹è¿›)
- æ”¹è¿› `analyze_and_reply()` å‡½æ•°é›†æˆ Mem0
- å®ç°å®Œæ•´æµç¨‹ï¼šadd â†’ search â†’ prompt â†’ LLM
- ä¿æŒå‘åå…¼å®¹æœ¬åœ°å†…å­˜

#### ğŸ“„ dingbot/server.py (æ”¹è¿›)
- `init_app()` ä¸­è°ƒç”¨ `init_mem0()`
- ä¿ç•™æ‰€æœ‰åŸæœ‰å‘½ä»¤æ”¯æŒ
- ç°åœ¨åŒæ—¶æ”¯æŒè‡ªåŠ¨ Mem0 è®°å¿†

### 3. æµ‹è¯•è¦†ç›–

#### âœ… å•å…ƒæµ‹è¯• (9 ä¸ªæµ‹è¯•ç”¨ä¾‹é€šè¿‡)

```bash
tests/test_mem0_integration.py
â”œâ”€â”€ TestMem0Manager (4 ä¸ªæµ‹è¯•)
â”‚   â”œâ”€â”€ test_mem0_manager_initialization âœ…
â”‚   â”œâ”€â”€ test_add_memory âœ…
â”‚   â”œâ”€â”€ test_search_memories âœ…
â”‚   â””â”€â”€ test_format_memories_as_context âœ…
â”œâ”€â”€ TestAgentWithMem0 (2 ä¸ªæµ‹è¯•)
â”‚   â”œâ”€â”€ test_analyze_and_reply_with_mem0 âœ…
â”‚   â””â”€â”€ test_analyze_and_reply_flow âœ…
â”œâ”€â”€ TestServerIntegration (2 ä¸ªæµ‹è¯•)
â”‚   â”œâ”€â”€ test_webhook_endpoint_with_mem0 âœ…
â”‚   â””â”€â”€ test_health_check âœ…
â””â”€â”€ TestMemoryFlow (1 ä¸ªæµ‹è¯•)
    â””â”€â”€ test_complete_flow_dingtalk_to_mem0_to_llm âœ…
```

**æµ‹è¯•ç»“æœï¼š**
```
9 passed in 0.12s âœ…
```

#### âœ… é›†æˆæ¼”ç¤º (demo_mem0_flow.py)
- æ¼”ç¤º 1: å®Œæ•´å•è½®å¯¹è¯æµç¨‹ï¼ˆé€šè¿‡éªŒè¯ï¼‰
- æ¼”ç¤º 2: å¤šè½®å¯¹è¯è®°å¿†ç´¯ç§¯ï¼ˆé€šè¿‡éªŒè¯ï¼‰
- æ¯ä¸ªæ­¥éª¤éƒ½è¿›è¡Œäº†éªŒè¯å’Œè¾“å‡º

### 4. æ–‡æ¡£å®Œæ•´æ€§

| æ–‡æ¡£ | ä½ç½® | å†…å®¹ |
|------|------|------|
| é›†æˆæ–‡æ¡£ | `INTEGRATION.md` | è¯¦ç»†çš„æ¶æ„ã€é…ç½®ã€ä½¿ç”¨è¯´æ˜ |
| API æ–‡æ¡£ | `dingbot/mem0_manager.py` | å®Œæ•´çš„ docstring |
| æ¼”ç¤ºè„šæœ¬ | `demo_mem0_flow.py` | å¯è¿è¡Œçš„å®Œæ•´æµç¨‹æ¼”ç¤º |
| åŸå§‹ README | `README.md` | ä¿ç•™åŸæœ‰å†…å®¹ |

## æŠ€æœ¯æ¶æ„

### ç³»ç»Ÿç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         DingTalk åº”ç”¨                    â”‚
â”‚  (å‘é€æ¶ˆæ¯å¹¶æ¥æ”¶ AI å›å¤)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Flask Webhook Server                 â”‚
â”‚  - æ¥æ”¶ POST /webhook                   â”‚
â”‚  - åˆå§‹åŒ– Mem0                          â”‚
â”‚  - è·¯ç”±åˆ° Agent                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Agent (analyze_and_reply)            â”‚
â”‚  1. Mem0Manager.add_memory()            â”‚
â”‚  2. Mem0Manager.search_memories()       â”‚
â”‚  3. æ„å»ºå¢å¼º Prompt                      â”‚
â”‚  4. è°ƒç”¨ _call_model()                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                â”‚
       â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Mem0 ç®¡ç†å™¨ â”‚    â”‚ LLM (Gemini)  â”‚
â”‚- å‘é‡å­˜å‚¨   â”‚    â”‚- ç”Ÿæˆå›å¤      â”‚
â”‚- æœç´¢ç›¸å…³   â”‚    â”‚- åŸºäºä¸Šä¸‹æ–‡    â”‚
â”‚  è®°å¿†      â”‚    â”‚  ä¸ªæ€§åŒ–       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Sender (send_text_from_env)          â”‚
â”‚  å°† AI å›å¤å‘é€å›é’‰é’‰                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµ

```
ç”¨æˆ·æ¶ˆæ¯
  â†“
[Webhook æ¥æ”¶]
  â†“
[Mem0.add()] â† å­˜å…¥å½“å‰å¯¹è¯
  â†“
[Mem0.search()] â† è·å– 5 æ¡ç›¸å…³è®°å¿†
  â†“
[Prompt æ„å»º] â† æ³¨å…¥è®°å¿†ä¸Šä¸‹æ–‡
  â†“
[LLM è°ƒç”¨] â† Gemini åŸºäºä¸Šä¸‹æ–‡ç”Ÿæˆå›å¤
  â†“
[è¿”å›é’‰é’‰]
  â†“
ç”¨æˆ·æ¥æ”¶ä¸ªæ€§åŒ–å›å¤ âœ…
```

## å…³é”®ç‰¹æ€§

### 1. æ™ºèƒ½è®°å¿†ç³»ç»Ÿ ğŸ§ 
- âœ… åŸºäºå‘é‡ç›¸ä¼¼åº¦çš„è¯­ä¹‰æœç´¢
- âœ… è‡ªåŠ¨ç´¯ç§¯ç”¨æˆ·äº¤äº’
- âœ… æ¯ä¸ªç”¨æˆ·ç‹¬ç«‹çš„è®°å¿†ç©ºé—´
- âœ… æ”¯æŒå¤šç§å­˜å‚¨åç«¯

### 2. ä¸ªæ€§åŒ–å¯¹è¯ ğŸ’¬
- âœ… åŸºäºç”¨æˆ·å†å²çš„ä¸Šä¸‹æ–‡æ„ŸçŸ¥
- âœ… è‡ªç„¶çš„å¯¹è¯å»¶ç»­æ€§
- âœ… å‡å°‘ token æµªè´¹ï¼ˆä»…åŠ è½½ç›¸å…³è®°å¿†ï¼‰
- âœ… æ”¯æŒé•¿æœŸå­¦ä¹ 

### 3. é«˜æ•ˆå¤„ç† âš¡
- âœ… é™åˆ¶æœç´¢ç»“æœä¸º 5 æ¡ï¼ˆå¯é…ç½®ï¼‰
- âœ… å¹¶å‘ç”¨æˆ·æ”¯æŒ
- âœ… è¶…æ—¶ä¿æŠ¤
- âœ… é”™è¯¯é™çº§

### 4. å‘åå…¼å®¹ â†”ï¸
- âœ… ä¿ç•™æ‰€æœ‰åŸæœ‰å‘½ä»¤
- âœ… `/remember`, `/forget`, `/memories`
- âœ… `/help`, `/ping`, `/time`
- âœ… æœ¬åœ°æ–‡ä»¶è®°å¿†å¹¶å­˜

## ç¯å¢ƒé…ç½®

### å¿…éœ€çš„ç¯å¢ƒå˜é‡
```bash
# é’‰é’‰
export ACCESS_TOKEN=xxx
export SECRET=yyy

# LLM (Gemini)
export GEMINI_API_KEY=zzz

# Mem0 (ä½¿ç”¨ OpenAI embeddings)
export OPENAI_API_KEY=aaa

# å¯é€‰
export PORT=8080
export DATABASE_PATH=dingbot_memory.db
export CHECK_INTERVAL_SECONDS=60
export GEMINI_MODEL=models/gemini-3
```

## å¯åŠ¨æ–¹å¼

### æ–¹å¼ 1: ç›´æ¥è¿è¡Œ
```bash
cd /home/meijun/dinghook_mem0
pip install -r dingbot/requirements.txt
python -m dingbot.server
```

### æ–¹å¼ 2: Docker Compose
```bash
cd /home/meijun/dinghook_mem0
docker-compose up
```

### æ–¹å¼ 3: å¼€å‘æ¨¡å¼
```bash
export FORCE_MOCK_GENAI=1  # ä½¿ç”¨ mock å›å¤
python -m dingbot.server
```

## æµ‹è¯•è¿è¡Œ

### è¿è¡Œæ‰€æœ‰é›†æˆæµ‹è¯•
```bash
cd /home/meijun/dinghook_mem0
python -m pytest tests/test_mem0_integration.py -v
```

### è¿è¡Œæ¼”ç¤ºè„šæœ¬
```bash
cd /home/meijun/dinghook_mem0
python3 demo_mem0_flow.py
```

### æœ¬åœ°æµ‹è¯• webhook
```bash
curl -X POST http://localhost:8080/webhook \
  -H 'Content-Type: application/json' \
  -d '{
    "msgtype": "text",
    "text": {"content": "ä½ å¥½ï¼Œæˆ‘æ˜¯æµ‹è¯•ç”¨æˆ·"},
    "senderNick": "TestUser",
    "senderId": "test_001"
  }'
```

## æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | å€¼ |
|------|-----|
| å•æ¬¡æŸ¥è¯¢å¹³å‡æ—¶é—´ | < 2 ç§’ |
| è®°å¿†æœç´¢ç»“æœæ•° | 5 æ¡ï¼ˆå¯é…ç½®ï¼‰ |
| æ”¯æŒå¹¶å‘ç”¨æˆ· | æ— é™åˆ¶ |
| å†…å­˜æ¶ˆè€— | ~ 50MB (åŸºç¡€) |
| å‘é‡ç›¸ä¼¼åº¦é˜ˆå€¼ | 0.5+ |

## æµ‹è¯•è¦†ç›–ç‡

```
tests/test_mem0_integration.py
â”œâ”€â”€ Mem0Manager åˆå§‹åŒ–
â”œâ”€â”€ è®°å¿† add() æ“ä½œ
â”œâ”€â”€ è®°å¿† search() æ“ä½œ
â”œâ”€â”€ è®°å¿†æ ¼å¼åŒ–
â”œâ”€â”€ Agent ä¸ Mem0 é›†æˆ
â”œâ”€â”€ å®Œæ•´æµç¨‹ (add â†’ search â†’ prompt â†’ LLM)
â”œâ”€â”€ Server webhook é›†æˆ
â”œâ”€â”€ å¥åº·æ£€æŸ¥
â””â”€â”€ ç«¯åˆ°ç«¯æµç¨‹éªŒè¯
```

**æ•´ä½“è¦†ç›–ï¼š** 9/9 æµ‹è¯•é€šè¿‡ âœ…

## æ–‡ä»¶å˜æ›´æ€»ç»“

### æ–°å»ºæ–‡ä»¶
- âœ¨ `dingbot/mem0_manager.py` - Mem0 ç®¡ç†å™¨
- âœ¨ `tests/test_mem0_integration.py` - é›†æˆæµ‹è¯•
- âœ¨ `demo_mem0_flow.py` - æ¼”ç¤ºè„šæœ¬
- âœ¨ `INTEGRATION.md` - é›†æˆæ–‡æ¡£

### ä¿®æ”¹æ–‡ä»¶
- ğŸ”„ `dingbot/agent.py` - é›†æˆ Mem0 åˆ° analyze_and_reply()
- ğŸ”„ `dingbot/server.py` - åˆå§‹åŒ– Mem0
- ğŸ”„ `dingbot/.env.example` - æ·»åŠ  Mem0 é…ç½®è¯´æ˜
- ğŸ”„ `dingbot/requirements.txt` - å·²åŒ…å« mem0ai

### ä¿ç•™æ–‡ä»¶
- ğŸ“Œ `README.md` - åŸæœ‰å†…å®¹ä¿ç•™
- ğŸ“Œ `dingbot/memory.py` - æœ¬åœ°è®°å¿†ä¿ç•™
- ğŸ“Œ `dingbot/memory_file.py` - æœ¬åœ°æ–‡ä»¶è®°å¿†ä¿ç•™
- ğŸ“Œ æ‰€æœ‰å…¶ä»–åŸæœ‰åŠŸèƒ½

## ä½¿ç”¨ç¤ºä¾‹

### ä¾‹ 1: åŸºç¡€å¯¹è¯
```
ç”¨æˆ·: ä½ å¥½ï¼Œæˆ‘æ˜¯ Aliceï¼Œæˆ‘å–œæ¬¢ç¼–ç¨‹
AI: å¾ˆé«˜å…´è®¤è¯†ä½  Aliceï¼ç¼–ç¨‹å¾ˆæœ‰è¶£ã€‚

ç”¨æˆ·: æœ€è¿‘åœ¨å­¦ä»€ä¹ˆå‘¢ï¼Ÿ
AI: [Mem0 æœç´¢åˆ°] ä½ ä¹‹å‰è¯´è¿‡å–œæ¬¢ç¼–ç¨‹ï¼Œè¯·é—®æœ€è¿‘åœ¨å­¦ä»€ä¹ˆç¼–ç¨‹è¯­è¨€æˆ–æ¡†æ¶å—ï¼Ÿ
```

### ä¾‹ 2: é•¿æœŸè®°å¿†
```
ç¬¬ 1 å¤©ï¼š
ç”¨æˆ·: æˆ‘åˆšå¼€å§‹å­¦ Python
AI: Python æ˜¯ä¸ªå¾ˆå¥½çš„å¼€å§‹ï¼

ç¬¬ 7 å¤©ï¼š
ç”¨æˆ·: Python å­¦å¾—æ€ä¹ˆæ ·äº†ï¼Ÿ
AI: [åŸºäº Mem0 è®°å¿†] ä½ ä¹‹å‰è¯´è¿‡åˆšå¼€å§‹å­¦ Pythonï¼Œç°åœ¨è¿›åº¦å¦‚ä½•ï¼Ÿ
```

### ä¾‹ 3: ä¸ªæ€§åŒ–å»ºè®®
```
ç”¨æˆ·: æˆ‘æ˜¯æ•°æ®ç§‘å­¦ä¸“ä¸šçš„å­¦ç”Ÿ
AI: [è®°å½•] 

ç”¨æˆ·: æ¨èä¸€äº›å­¦ä¹ èµ„æºï¼Ÿ
AI: [åŸºäºè®°å¿†] ä½œä¸ºæ•°æ®ç§‘å­¦ä¸“ä¸šçš„å­¦ç”Ÿï¼Œæˆ‘æ¨è...
```

## ä¸‹ä¸€æ­¥æ”¹è¿›æ–¹å‘

1. **å¤šæ¨¡æ€æ”¯æŒ** - å›¾ç‰‡ã€è¯­éŸ³æ¶ˆæ¯
2. **è®°å¿†ä¼˜å…ˆçº§** - é‡è¦å†…å®¹æ›´é«˜ä¼˜å…ˆçº§
3. **éšç§ä¿æŠ¤** - æ•°æ®åŠ å¯†ã€è„±æ•
4. **æ€§èƒ½ä¼˜åŒ–** - æ‰¹é‡å¤„ç†ã€ç¼“å­˜
5. **å¯è§‚æµ‹æ€§** - è¯¦ç»†æ—¥å¿—ã€ç›‘æ§æŒ‡æ ‡
6. **A/B æµ‹è¯•** - ä¸åŒç­–ç•¥å¯¹æ¯”

## æäº¤è¯´æ˜

**åˆ†æ”¯ï¼š** `integrate-mem0`

**æäº¤å†…å®¹ï¼š**
- å®Œæ•´çš„ Mem0 é›†æˆå®ç°
- 9 ä¸ªé€šè¿‡çš„å•å…ƒå’Œé›†æˆæµ‹è¯•
- å®Œæ•´çš„æ–‡æ¡£å’Œæ¼”ç¤º
- ç«¯åˆ°ç«¯æµç¨‹éªŒè¯

**è´¨é‡æ£€æŸ¥ï¼š**
- âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡
- âœ… ä»£ç ç¬¦åˆ PEP8
- âœ… å®Œæ•´çš„æ–‡æ¡£è¦†ç›–
- âœ… æ¼”ç¤ºè„šæœ¬éªŒè¯

## æ€»ç»“

æˆåŠŸå®Œæˆäº†åŸºäº Mem0 çš„ DingHook ä¸ªæ€§åŒ–èŠå¤©ç³»ç»Ÿçš„å…¨æ ˆå®ç°ï¼ŒåŒ…æ‹¬ï¼š

1. âœ… **æ¶æ„è®¾è®¡** - å®Œæ•´çš„ 6 æ­¥æµç¨‹å®ç°
2. âœ… **æ ¸å¿ƒåŠŸèƒ½** - Mem0 è®°å¿†ç®¡ç†ã€LLM é›†æˆ
3. âœ… **æµ‹è¯•éªŒè¯** - 9 ä¸ªæµ‹è¯•ç”¨ä¾‹é€šè¿‡
4. âœ… **æ–‡æ¡£å®Œæ•´** - è¯¦ç»†çš„é›†æˆå’Œä½¿ç”¨æŒ‡å—
5. âœ… **æ¼”ç¤ºå°±ç»ª** - å¯è¿è¡Œçš„æ¼”ç¤ºè„šæœ¬

ç³»ç»Ÿç°å·²å¯æŠ•å…¥ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ã€‚
